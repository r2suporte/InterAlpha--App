#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Executando verificaÃ§Ãµes prÃ©-push..."

# Verificar se estamos na branch main/master
current_branch=$(git branch --show-current)
if [ "$current_branch" = "main" ] || [ "$current_branch" = "master" ]; then
  echo "âš ï¸  Fazendo push para branch principal ($current_branch)"
  echo "ğŸ” Executando verificaÃ§Ãµes completas..."
  
  # Executar verificaÃ§Ãµes completas para branch principal
  echo "ğŸ“‹ Executando verificaÃ§Ã£o completa..."
  npm run full:check
  
  if [ $? -ne 0 ]; then
    echo "âŒ VerificaÃ§Ãµes completas falharam. Corrija os problemas antes de fazer push para $current_branch."
    exit 1
  fi
else
  echo "ğŸ“ Branch: $current_branch"
  
  # VerificaÃ§Ãµes bÃ¡sicas para outras branches
  echo "ğŸ” Executando verificaÃ§Ãµes bÃ¡sicas..."
  npm run code:check
  
  if [ $? -ne 0 ]; then
    echo "âŒ VerificaÃ§Ãµes de cÃ³digo falharam."
    exit 1
  fi
  
  echo "ğŸ§ª Executando testes..."
  npm run test:ci
  
  if [ $? -ne 0 ]; then
    echo "âŒ Testes falharam."
    exit 1
  fi
fi

# Verificar se hÃ¡ commits com mensagens inadequadas
echo "ğŸ“ Verificando histÃ³rico de commits..."
if git log --oneline -10 | grep -iqE '(wip|fixup|squash|temp)'; then
  echo "âš ï¸  Commits temporÃ¡rios detectados no histÃ³rico recente"
  echo "ğŸ’¡ Considere fazer squash ou rebase antes do push"
fi

# Verificar tamanho dos arquivos
echo "ğŸ“¦ Verificando tamanho dos arquivos..."
large_files=$(git diff --cached --name-only | xargs -I {} find {} -size +1M 2>/dev/null)
if [ ! -z "$large_files" ]; then
  echo "âš ï¸  Arquivos grandes detectados:"
  echo "$large_files"
  echo "ğŸ’¡ Considere usar Git LFS para arquivos grandes"
fi

echo "âœ… Todas as verificaÃ§Ãµes prÃ©-push passaram! Prosseguindo com o push..."