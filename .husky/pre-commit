#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Executando verificaÃ§Ãµes prÃ©-commit..."

# Verificar se hÃ¡ arquivos staged
if git diff --cached --quiet; then
  echo "âŒ Nenhum arquivo staged para commit"
  exit 1
fi

# Executar verificaÃ§Ãµes de cÃ³digo apenas nos arquivos staged
echo "ğŸ“ Verificando formataÃ§Ã£o..."
npx prettier --check $(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx|json|css|md)$' | tr '\n' ' ')

if [ $? -ne 0 ]; then
  echo "âŒ Problemas de formataÃ§Ã£o encontrados. Execute 'npm run format:write' para corrigir."
  exit 1
fi

echo "ğŸ” Verificando lint..."
npx eslint $(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx)$' | tr '\n' ' ')

if [ $? -ne 0 ]; then
  echo "âŒ Problemas de lint encontrados. Execute 'npm run lint:fix' para corrigir."
  exit 1
fi

echo "ğŸ”§ Verificando tipos TypeScript..."
npm run type:check

if [ $? -ne 0 ]; then
  echo "âŒ Erros de tipo encontrados. Corrija os erros de TypeScript."
  exit 1
fi

# Executar testes unitÃ¡rios relacionados aos arquivos modificados
echo "ğŸ§ª Executando testes..."
npm run test -- --passWithNoTests --findRelatedTests $(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx)$' | tr '\n' ' ')

if [ $? -ne 0 ]; then
  echo "âŒ Testes falharam. Corrija os testes antes de fazer commit."
  exit 1
fi

# VerificaÃ§Ã£o de seguranÃ§a bÃ¡sica
echo "ğŸ”’ Verificando seguranÃ§a..."
if git diff --cached --name-only | grep -E '\.(env|key|pem|p12|pfx)$'; then
  echo "âŒ Arquivos sensÃ­veis detectados no commit. Remova-os antes de continuar."
  exit 1
fi

# Verificar se hÃ¡ secrets no cÃ³digo
if git diff --cached | grep -iE '(password|secret|key|token|api_key).*=.*["\'][^"\']{8,}["\']'; then
  echo "âŒ PossÃ­veis secrets detectados no cÃ³digo. Verifique e remova antes de continuar."
  exit 1
fi

echo "âœ… Todas as verificaÃ§Ãµes passaram! Prosseguindo com o commit..."